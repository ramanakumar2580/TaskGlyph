{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/ramanakumar/TaskGlyph/src/lib/db/clientDb.ts"],"sourcesContent":["import Dexie from \"dexie\";\n\n// --- INTERFACES ---\n\nexport interface Folder {\n  id: string; // CUID or UUID\n  name: string;\n  createdAt: number;\n  updatedAt: number;\n}\n\nexport interface UserMetadata {\n  userId: string;\n  trialStartedAt: number; // timestamp\n  tier: \"free\" | \"basic\" | \"pro\" | \"ultra_pro\";\n  hasNotesPassword?: boolean;\n  // [SECURITY FIX] Removed notesPasswordHash from client interface\n}\n\nexport interface Project {\n  id: string;\n  name: string;\n  description: string | null;\n  accentColor: string | null;\n  createdAt: number;\n  updatedAt: number;\n}\n\nexport type Priority = \"none\" | \"low\" | \"medium\" | \"high\";\nexport type RecurringSchedule = \"none\" | \"daily\" | \"weekly\" | \"monthly\";\n\nexport interface Task {\n  id: string;\n  title: string;\n  completed: boolean;\n  createdAt: number;\n  updatedAt: number;\n  projectId: string | null;\n  parentId: string | null;\n  notes: string | null;\n  dueDate: number | null;\n  priority: Priority;\n  tags: string[];\n  recurringSchedule: RecurringSchedule;\n  reminderAt: number | null;\n  meetLink: string | null;\n  reminder_30_sent: boolean;\n  reminder_20_sent: boolean;\n  reminder_10_sent: boolean;\n}\n\nexport interface Note {\n  id: string;\n  title: string;\n  content: string;\n  createdAt: number;\n  updatedAt: number;\n  folderId: string | null;\n  isPinned: boolean;\n  isLocked: boolean;\n  isQuickNote: boolean;\n  tags: string[];\n  deletedAt: number | null;\n}\n\n// --- Diary Interfaces ---\n\nexport interface DiaryMedia {\n  type: \"image\" | \"audio\";\n  url: string;\n  createdAt: number;\n}\n\nexport interface DiaryWeather {\n  temp: number;\n  condition: string;\n  city: string;\n}\n\nexport interface DiaryEntry {\n  id: string;\n  entryDate: string; // YYYY-MM-DD\n  content: string;\n  createdAt: number;\n  mood?: string;\n  energy?: number;\n  weather?: DiaryWeather | null;\n  location?: string;\n  tags?: string[];\n  isLocked?: boolean;\n  media?: DiaryMedia[];\n}\n\nexport interface PomodoroSession {\n  id: string;\n  durationMinutes: number;\n  completedAt: number;\n  // [UPDATED] Added short_break and long_break. Kept 'break' for backward compatibility.\n  type: \"work\" | \"break\" | \"short_break\" | \"long_break\";\n}\n\nexport interface Notification {\n  id: string;\n  userId: string;\n  message: string;\n  link: string | null;\n  read: boolean;\n  createdAt: number;\n}\n\nexport type EntityType =\n  | \"task\"\n  | \"project\"\n  | \"note\"\n  | \"diary\"\n  | \"pomodoro\"\n  | \"notification\"\n  | \"folder\";\n\nexport type OperationType = \"create\" | \"update\" | \"delete\";\n\nexport interface SyncOperation {\n  id: string;\n  entityType: EntityType;\n  operation: OperationType;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  payload: any;\n  timestamp: number;\n}\n\n// Create a subclass of Dexie for type safety\nclass TaskGlyphDB extends Dexie {\n  tasks!: Dexie.Table<Task, string>;\n  projects!: Dexie.Table<Project, string>;\n  diaryEntries!: Dexie.Table<DiaryEntry, string>;\n  pomodoroSessions!: Dexie.Table<PomodoroSession, string>;\n  syncOutbox!: Dexie.Table<SyncOperation, string>;\n  userMetadata!: Dexie.Table<UserMetadata, string>;\n  notifications!: Dexie.Table<Notification, string>;\n  notes!: Dexie.Table<Note, string>;\n  folders!: Dexie.Table<Folder, string>;\n\n  constructor() {\n    super(\"TaskGlyphDB\");\n\n    // ‚úÖ VERSION 10: Cleanest version for Production\n    // Removed notesPasswordHash from userMetadata for security\n    this.version(10).stores({\n      userMetadata: \"userId, hasNotesPassword\",\n      tasks:\n        \"id, title, completed, createdAt, updatedAt, projectId, parentId, dueDate, priority, *tags, reminderAt, recurringSchedule, meetLink, reminder_30_sent, reminder_20_sent, reminder_10_sent\",\n      projects: \"id, name, createdAt, updatedAt\",\n      diaryEntries: \"id, entryDate, createdAt, mood, *tags, isLocked\",\n      pomodoroSessions: \"id, durationMinutes, completedAt, type\",\n      syncOutbox: \"id, entityType, operation, timestamp\",\n      notifications: \"id, userId, read, createdAt\",\n      notes:\n        \"id, folderId, isPinned, deletedAt, isQuickNote, title, updatedAt, *tags\",\n      folders: \"id, name\",\n    });\n\n    // Version 9 (Migration history - kept for safety)\n    this.version(9).stores({\n      userMetadata: \"userId, hasNotesPassword, notesPasswordHash\",\n      tasks:\n        \"id, title, completed, createdAt, updatedAt, projectId, parentId, dueDate, priority, *tags, reminderAt, recurringSchedule, meetLink, reminder_30_sent, reminder_20_sent, reminder_10_sent\",\n      projects: \"id, name, createdAt, updatedAt\",\n      diaryEntries: \"id, entryDate, createdAt\",\n      pomodoroSessions: \"id, durationMinutes, completedAt, type\",\n      syncOutbox: \"id, entityType, operation, timestamp\",\n      notifications: \"id, userId, read, createdAt\",\n      notes:\n        \"id, folderId, isPinned, deletedAt, isQuickNote, title, updatedAt, *tags\",\n      folders: \"id, name\",\n    });\n\n    // Older versions...\n    this.version(8).stores({\n      userMetadata: \"userId, hasNotesPassword\",\n      tasks:\n        \"id, title, completed, createdAt, updatedAt, projectId, parentId, dueDate, priority, *tags, reminderAt, recurringSchedule, meetLink, reminder_30_sent, reminder_20_sent, reminder_10_sent\",\n      projects: \"id, name, createdAt, updatedAt\",\n      diaryEntries: \"id, entryDate, createdAt\",\n      pomodoroSessions: \"id, durationMinutes, completedAt, type\",\n      syncOutbox: \"id, entityType, operation, timestamp\",\n      notifications: \"id, userId, read, createdAt\",\n      notes:\n        \"id, folderId, isPinned, deletedAt, isQuickNote, title, updatedAt, *tags\",\n      folders: \"id, name\",\n    });\n    this.version(7).stores({\n      userMetadata: \"userId\",\n      tasks:\n        \"id, title, completed, createdAt, updatedAt, projectId, parentId, dueDate, priority, *tags, reminderAt, recurringSchedule, meetLink, reminder_30_sent, reminder_20_sent, reminder_10_sent\",\n      projects: \"id, name, createdAt, updatedAt\",\n      diaryEntries: \"id, entryDate, createdAt\",\n      pomodoroSessions: \"id, durationMinutes, completedAt, type\",\n      syncOutbox: \"id, entityType, operation, timestamp\",\n      notifications: \"id, userId, read, createdAt\",\n      notes:\n        \"id, folderId, isPinned, deletedAt, isQuickNote, title, updatedAt, *tags\",\n      folders: \"id, name\",\n    });\n    this.version(6).stores({\n      userMetadata: \"userId\",\n      tasks:\n        \"id, title, completed, createdAt, updatedAt, projectId, parentId, dueDate, priority, *tags, reminderAt, recurringSchedule, meetLink, reminder_30_sent, reminder_20_sent, reminder_10_sent\",\n      projects: \"id, name, createdAt, updatedAt\",\n      diaryEntries: \"id, entryDate, createdAt\",\n      pomodoroSessions: \"id, durationMinutes, completedAt, type\",\n      syncOutbox: \"id, entityType, operation, timestamp\",\n      notifications: \"id, userId, read, createdAt\",\n      notes:\n        \"id, folderId, isPinned, deletedAt, isQuickNote, title, updatedAt, *tags\",\n      folders: \"id, name\",\n      noteAttachments: \"id, noteId, fileType\",\n    });\n    this.version(5).stores({\n      userMetadata: \"userId\",\n      tasks:\n        \"id, title, completed, createdAt, updatedAt, projectId, parentId, dueDate, priority, *tags, reminderAt, recurringSchedule, meetLink, reminder_30_sent, reminder_20_sent, reminder_10_sent\",\n      projects: \"id, name, createdAt, updatedAt\",\n      diaryEntries: \"id, entryDate, createdAt\",\n      pomodoroSessions: \"id, durationMinutes, completedAt, type\",\n      syncOutbox: \"id, entityType, operation, timestamp\",\n      notifications: \"id, userId, read, createdAt\",\n      notes: \"id, folderId, isPinned, deletedAt, isQuickNote, title, updatedAt\",\n      folders: \"id, name\",\n      noteAttachments: \"id, noteId, fileType\",\n    });\n    this.version(4).stores({\n      userMetadata: \"userId\",\n      tasks:\n        \"id, title, completed, createdAt, updatedAt, projectId, parentId, dueDate, priority, *tags, reminderAt, recurringSchedule, meetLink, reminder_30_sent, reminder_20_sent, reminder_10_sent\",\n      projects: \"id, name, createdAt, updatedAt\",\n      notes: \"id, title, createdAt, updatedAt\",\n      diaryEntries: \"id, entryDate, createdAt\",\n      pomodoroSessions: \"id, durationMinutes, completedAt, type\",\n      syncOutbox: \"id, entityType, operation, timestamp\",\n      notifications: \"id, userId, read, createdAt\",\n    });\n    this.version(3).stores({\n      userMetadata: \"userId\",\n      tasks:\n        \"id, title, completed, createdAt, updatedAt, projectId, parentId, dueDate, priority, *tags, reminderAt, recurringSchedule\",\n      projects: \"id, name, createdAt, updatedAt\",\n      notes: \"id, title, createdAt, updatedAt\",\n      diaryEntries: \"id, entryDate, createdAt\",\n      pomodoroSessions: \"id, durationMinutes, completedAt, type\",\n      syncOutbox: \"id, entityType, operation, timestamp\",\n    });\n    this.version(2).stores({\n      userMetadata: \"userId\",\n      tasks: \"id, title, completed, createdAt, updatedAt\",\n      notes: \"id, title, createdAt, updatedAt\",\n      diaryEntries: \"id, entryDate, createdAt\",\n      pomodoroSessions: \"id, durationMinutes, completedAt, type\",\n      syncOutbox: \"id, entityType, operation, timestamp\",\n    });\n    this.version(1).stores({\n      userMetadata: \"userId\",\n      tasks: \"id, title, completed, createdAt, updatedAt\",\n      notes: \"id, title, createdAt, updatedAt\",\n      diaryEntries: \"id, entryDate, createdAt\",\n      pomodoroSessions: \"id, durationMinutes, completedAt\",\n      syncOutbox: \"id, entityType, operation, timestamp\",\n    });\n  }\n}\n\n// Export a singleton instance\nconst db = new TaskGlyphDB();\n\nexport default db;\n"],"names":[],"mappings":";;;;;AAAA;;;AAkIA,6CAA6C;AAC7C,MAAM,oBAAoB,yJAAK;IAW7B,aAAc;QACZ,KAAK,CAAC,gBAXR,uMAAA,SAAA,KAAA,IACA,uMAAA,YAAA,KAAA,IACA,uMAAA,gBAAA,KAAA,IACA,uMAAA,oBAAA,KAAA,IACA,uMAAA,cAAA,KAAA,IACA,uMAAA,gBAAA,KAAA,IACA,uMAAA,iBAAA,KAAA,IACA,uMAAA,SAAA,KAAA,IACA,uMAAA,WAAA,KAAA;QAKE,gDAAgD;QAChD,2DAA2D;QAC3D,IAAI,CAAC,OAAO,CAAC,IAAI,MAAM,CAAC;YACtB,cAAc;YACd,OACE;YACF,UAAU;YACV,cAAc;YACd,kBAAkB;YAClB,YAAY;YACZ,eAAe;YACf,OACE;YACF,SAAS;QACX;QAEA,kDAAkD;QAClD,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC;YACrB,cAAc;YACd,OACE;YACF,UAAU;YACV,cAAc;YACd,kBAAkB;YAClB,YAAY;YACZ,eAAe;YACf,OACE;YACF,SAAS;QACX;QAEA,oBAAoB;QACpB,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC;YACrB,cAAc;YACd,OACE;YACF,UAAU;YACV,cAAc;YACd,kBAAkB;YAClB,YAAY;YACZ,eAAe;YACf,OACE;YACF,SAAS;QACX;QACA,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC;YACrB,cAAc;YACd,OACE;YACF,UAAU;YACV,cAAc;YACd,kBAAkB;YAClB,YAAY;YACZ,eAAe;YACf,OACE;YACF,SAAS;QACX;QACA,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC;YACrB,cAAc;YACd,OACE;YACF,UAAU;YACV,cAAc;YACd,kBAAkB;YAClB,YAAY;YACZ,eAAe;YACf,OACE;YACF,SAAS;YACT,iBAAiB;QACnB;QACA,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC;YACrB,cAAc;YACd,OACE;YACF,UAAU;YACV,cAAc;YACd,kBAAkB;YAClB,YAAY;YACZ,eAAe;YACf,OAAO;YACP,SAAS;YACT,iBAAiB;QACnB;QACA,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC;YACrB,cAAc;YACd,OACE;YACF,UAAU;YACV,OAAO;YACP,cAAc;YACd,kBAAkB;YAClB,YAAY;YACZ,eAAe;QACjB;QACA,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC;YACrB,cAAc;YACd,OACE;YACF,UAAU;YACV,OAAO;YACP,cAAc;YACd,kBAAkB;YAClB,YAAY;QACd;QACA,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC;YACrB,cAAc;YACd,OAAO;YACP,OAAO;YACP,cAAc;YACd,kBAAkB;YAClB,YAAY;QACd;QACA,IAAI,CAAC,OAAO,CAAC,GAAG,MAAM,CAAC;YACrB,cAAc;YACd,OAAO;YACP,OAAO;YACP,cAAc;YACd,kBAAkB;YAClB,YAAY;QACd;IACF;AACF;AAEA,8BAA8B;AAC9B,MAAM,KAAK,IAAI;uCAEA","debugId":null}},
    {"offset": {"line": 135, "column": 0}, "map": {"version":3,"sources":["file:///Users/ramanakumar/TaskGlyph/src/lib/sync/syncService.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport db from \"@/lib/db/clientDb\";\n\nlet isPushing = false;\nlet isPulling = false;\nconst SYNC_TRIGGER_EVENT = \"taskglyph-sync-trigger\";\nconst LAST_PULL_KEY = \"taskglyph_last_pull\";\n\n// ‚úÖ --- [FIX] A new flag to queue a push ---\nlet pushNeededAfterCurrent = false;\n\nfunction debounce<F extends (...args: any[]) => any>(func: F, waitFor: number) {\n  let timeout: ReturnType<typeof setTimeout> | null = null;\n  const debounced = (...args: Parameters<F>) => {\n    if (timeout) clearTimeout(timeout);\n    timeout = setTimeout(() => func(...args), waitFor);\n  };\n  return debounced as (...args: Parameters<F>) => void;\n}\n\nexport function triggerSync() {\n  console.log(\"Poking sync service...\");\n  window.dispatchEvent(new Event(SYNC_TRIGGER_EVENT));\n}\n\nexport function isOnline(): boolean {\n  return typeof window !== \"undefined\" && navigator.onLine;\n}\n\nexport async function pushChangesToServer(): Promise<void> {\n  if (!isOnline()) {\n    console.log(\"Offline, PUSH aborted.\");\n    return;\n  }\n\n  // ‚úÖ --- [FIX #1] Handle the \"deadlock\" ---\n  // If a push is already running, set a flag to\n  // run another one right after it finishes.\n  if (isPushing) {\n    console.log(\"PUSH already in progress, queuing another push.\");\n    pushNeededAfterCurrent = true;\n    return;\n  }\n  // --- End of Fix #1 ---\n\n  isPushing = true;\n\n  try {\n    // Get the outbox *inside* the try block\n    const outbox = await db.syncOutbox.toArray();\n\n    if (outbox.length === 0) {\n      console.log(\"‚úÖ PUSH: Outbox is empty\");\n      // Do not return here. Let the 'finally' block run.\n    } else {\n      console.log(`üì§ PUSH: Flushing ${outbox.length} operations to server...`);\n\n      const response = await fetch(\"/api/sync\", {\n        method: \"POST\",\n        credentials: \"include\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ operations: outbox }),\n      });\n\n      if (!response.ok) {\n        let errorText = \"Unknown error\";\n        try {\n          const error = await response.json();\n          errorText = JSON.stringify(error, null, 2);\n        } catch {\n          errorText = await response.text();\n        }\n        console.log(`‚ùå PUSH failed: ${errorText}`);\n      } else {\n        const result = await response.json();\n        console.log(\"‚úÖ PUSH result:\", result);\n\n        const successIds = result.results\n          .filter((r: any) => r.success)\n          .map((r: any) => r.id);\n\n        if (successIds.length > 0) {\n          await db.syncOutbox.bulkDelete(successIds);\n          console.log(\n            `üóëÔ∏è PUSH: Removed ${successIds.length} synced operations from outbox`\n          );\n        }\n      }\n    }\n  } catch (error) {\n    console.error(\"‚ùå PUSH: Network error during sync:\", error);\n  } finally {\n    isPushing = false; // Release the lock\n    console.log(\"PUSH finished.\");\n\n    // Check if another push was requested while this one was running\n    if (pushNeededAfterCurrent) {\n      console.log(\"Changes came in during push. Running another push.\");\n      pushNeededAfterCurrent = false; // Clear the flag\n      setTimeout(pushChangesToServer, 50);\n    }\n    // --- End of Fixes ---\n  }\n}\n\nexport async function pullChangesFromServer(): Promise<void> {\n  if (!isOnline()) {\n    console.log(\"Offline, PULL aborted.\");\n    return;\n  }\n  if (isPulling) {\n    console.log(\"PULL already in progress, skipping.\");\n    return;\n  }\n  isPulling = true;\n\n  try {\n    const lastPulledAt = localStorage.getItem(LAST_PULL_KEY) || 0;\n    console.log(`üîΩ PULL: Fetching changes since ${lastPulledAt}`);\n\n    const response = await fetch(`/api/sync?since=${lastPulledAt}`, {\n      credentials: \"include\",\n    });\n\n    if (!response.ok) {\n      throw new Error(`Server error: ${response.statusText}`);\n    }\n\n    const data = await response.json();\n\n    const dataArrays = [\n      data.userMetadata,\n      data.projects,\n      data.tasks,\n      data.notes,\n      data.folders,\n      data.diaryEntries,\n      data.pomodoroSessions,\n      data.notifications,\n    ];\n    const hasNewData = dataArrays.some(\n      (arr) => Array.isArray(arr) && arr.length > 0\n    );\n\n    if (!hasNewData) {\n      console.log(\"‚úÖ PULL: No new changes from server.\");\n      isPulling = false;\n      return;\n    }\n\n    console.log(\"üîΩ PULL: Applying changes from server...\");\n    await db.transaction(\n      \"rw\",\n      [\n        db.userMetadata,\n        db.projects,\n        db.tasks,\n        db.notes,\n        db.folders,\n        db.diaryEntries,\n        db.pomodoroSessions,\n        db.notifications,\n      ],\n      async () => {\n        if (data.userMetadata.length > 0)\n          await db.userMetadata.bulkPut(data.userMetadata);\n        if (data.projects.length > 0) await db.projects.bulkPut(data.projects);\n        if (data.tasks.length > 0) await db.tasks.bulkPut(data.tasks);\n        if (data.notes.length > 0) await db.notes.bulkPut(data.notes);\n        if (data.folders.length > 0) await db.folders.bulkPut(data.folders);\n        if (data.diaryEntries.length > 0)\n          await db.diaryEntries.bulkPut(data.diaryEntries);\n        if (data.pomodoroSessions.length > 0)\n          await db.pomodoroSessions.bulkPut(data.pomodoroSessions);\n        if (data.notifications.length > 0)\n          await db.notifications.bulkPut(data.notifications);\n      }\n    );\n\n    localStorage.setItem(LAST_PULL_KEY, data.timestamp);\n    console.log(\"‚úÖ PULL: Sync complete. New timestamp set to\", data.timestamp);\n  } catch (error) {\n    console.error(\"‚ùå PULL: Error fetching changes:\", error);\n  } finally {\n    isPulling = false;\n  }\n}\n\nexport function startBackgroundSync(): () => void {\n  console.log(\"Starting full two-way background sync...\");\n\n  if (isOnline()) {\n    pushChangesToServer();\n  }\n\n  if (isOnline()) {\n    pullChangesFromServer();\n  }\n\n  const handleOnline = () => {\n    console.log(\"üåê Back online ‚Äî triggering PUSH\");\n    pushChangesToServer();\n  };\n\n  const debouncedHandleOnline = debounce(handleOnline, 2000);\n  window.addEventListener(\"online\", debouncedHandleOnline);\n\n  // 4. Listen for pokes\n  const handleSyncTrigger = () => {\n    console.log(\"Sync poke received, triggering push...\");\n    // The push function itself will now handle the lock and queue\n    pushChangesToServer();\n  };\n  window.addEventListener(SYNC_TRIGGER_EVENT, handleSyncTrigger);\n\n  const pullInterval = setInterval(pullChangesFromServer, 60000);\n\n  return () => {\n    window.removeEventListener(\"online\", debouncedHandleOnline);\n    window.removeEventListener(SYNC_TRIGGER_EVENT, handleSyncTrigger);\n    clearInterval(pullInterval);\n  };\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 338, "column": 0}, "map": {"version":3,"sources":["file:///Users/ramanakumar/TaskGlyph/src/app/layout-client.tsx"],"sourcesContent":["\"use client\";\n\nimport { SessionProvider, useSession } from \"next-auth/react\";\nimport { useEffect, useState } from \"react\";\nimport { startBackgroundSync } from \"@/lib/sync/syncService\";\nimport db from \"@/lib/db/clientDb\"; // Import your Dexie db\n\n// A simple loading spinner component\nfunction InitialSyncLoading() {\n  return (\n    <div\n      style={{\n        display: \"flex\",\n        alignItems: \"center\",\n        justifyContent: \"center\",\n        height: \"100vh\",\n        backgroundColor: \"#111\",\n        color: \"white\",\n        fontFamily: \"sans-serif\",\n      }}\n    >\n      <p>Syncing your data...</p>\n    </div>\n  );\n}\n\n// We create a new component that *contains* the sync logic\n// because we can only call useSession() inside a <SessionProvider>.\nfunction SyncManager({ children }: { children: React.ReactNode }) {\n  const { data: session } = useSession();\n  const [isInitialSyncing, setIsInitialSyncing] = useState(true);\n  const [isSyncLogicDone, setIsSyncLogicDone] = useState(false);\n\n  useEffect(() => {\n    // Prevent this effect from running more than once\n    if (!session?.user?.id || isSyncLogicDone) {\n      if (!session?.user?.id) {\n        setIsInitialSyncing(false); // Not logged in, so not syncing\n      }\n      return;\n    }\n\n    // Mark that we've run the logic\n    setIsSyncLogicDone(true);\n\n    const checkAndFetchData = async () => {\n      try {\n        console.log(\"Checking local database...\");\n        // Check if the main tables are empty\n        const noteCount = await db.notes.count();\n        const taskCount = await db.tasks.count();\n        const projectCount = await db.projects.count();\n\n        // If all are 0, it's a fresh (or cleared) database\n        if (noteCount === 0 && taskCount === 0 && projectCount === 0) {\n          console.log(\"Local database is empty. Checking online status...\");\n\n          // ‚úÖ --- [THE FIX] ---\n          // Only attempt to fetch from the server if we are ONLINE.\n          // If we are offline, we just skip this and the app will\n          // load in an empty state, which is correct.\n          if (navigator.onLine) {\n            console.log(\"Online. Fetching from server...\");\n\n            // Call our new GET endpoint\n            const res = await fetch(\"/api/sync\");\n            if (!res.ok) {\n              throw new Error(`Server error: ${res.statusText}`);\n            }\n\n            const data = await res.json();\n            console.log(\"Got data from server, populating local database...\");\n\n            localStorage.setItem(\"taskglyph_last_pull\", data.timestamp);\n\n            // Use a Dexie transaction to add all data at once\n            await db.transaction(\n              \"rw\",\n              [\n                db.userMetadata,\n                db.projects,\n                db.tasks,\n                db.notes,\n                db.folders,\n                db.diaryEntries,\n                db.pomodoroSessions,\n                db.notifications,\n              ],\n              async () => {\n                // Use 'bulkPut' for all tables (idempotent)\n                await db.userMetadata.bulkPut(data.userMetadata);\n                await db.projects.bulkPut(data.projects);\n                await db.tasks.bulkPut(data.tasks);\n                await db.notes.bulkPut(data.notes);\n                await db.folders.bulkPut(data.folders);\n                await db.diaryEntries.bulkPut(data.diaryEntries);\n                await db.pomodoroSessions.bulkPut(data.pomodoroSessions);\n                await db.notifications.bulkPut(data.notifications);\n              }\n            );\n            console.log(\"Local database populated successfully.\");\n          } else {\n            console.log(\"Offline. Skipping server fetch. App will load empty.\");\n          }\n          // ‚úÖ --- END OF FIX ---\n        } else {\n          console.log(\n            \"Local database already has data. Skipping initial fetch.\"\n          );\n        }\n      } catch (error) {\n        console.error(\"Failed during initial sync:\", error);\n      } finally {\n        // This will now run even if we are offline,\n        // hiding the loading spinner.\n        setIsInitialSyncing(false);\n      }\n    };\n\n    checkAndFetchData();\n\n    // Start background sync for ongoing changes\n    console.log(\"Starting global background sync...\");\n    const cleanup = startBackgroundSync();\n\n    return cleanup; // Clean up event listener on unmount\n  }, [session?.user?.id, isSyncLogicDone]);\n\n  // Show a loading screen *only* during the initial data fetch\n  if (isInitialSyncing) {\n    return <InitialSyncLoading />;\n  }\n\n  return <>{children}</>;\n}\n\nexport default function LayoutClient({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <SessionProvider>\n      <SyncManager>{children}</SyncManager>\n    </SessionProvider>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}